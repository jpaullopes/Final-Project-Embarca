/**
 * Exemplo de acionamento do buzzer utilizando sinal PWM no GPIO 21 da Raspberry Pico / BitDogLab
 * 06/12/2024
 */

#include <stdio.h>
#include "pico/stdlib.h"
#include "hardware/pwm.h"
#include "hardware/clocks.h"

// Configuração do pino do buzzer
#define BUZZER_PIN 21

// Notas musicais para a música tema de Star Wars
const uint star_wars_notes[] = {
    0, 466, 0, 466, 440, 0, 440, 466,
    0, 466, 0, 262, 392, 0, 392, 466,
    0, 440, 0, 440, 0, 392, 0, 392,
    415, 440, 0, 440, 466, 0, 466, 349,
    0, 262, 0, 392, 466, 0, 440, 0,
    440, 0, 466, 0, 466, 0, 311, 440,
    0, 415, 0, 415, 311, 262, 0, 392,
    0, 392, 0, 392, 0, 392, 0, 370,
    392, 0, 392, 0, 392, 0, 370, 0,
    370, 0, 370, 0, 370, 392, 0, 392,
    262, 0, 311, 392, 0, 392, 370, 0,
    370, 277, 0, 392, 0, 392, 0, 392,
    0, 262, 0, 523, 0, 523, 262, 523,
    0, 523, 0, 349, 0, 349, 0, 523,
    0, 523, 0, 370, 0, 370, 0, 466,
    0, 311, 0, 311, 0, 466, 0, 392,
    0, 311, 0, 392, 415, 0, 740, 0,
    622, 0, 277, 294, 277, 0, 262, 0,
    415, 0, 415, 392, 415, 277, 466, 294,
    311, 622, 311, 622, 311, 294, 0, 440,
    466, 0, 466, 440, 466, 0, 262, 466,
    0, 349, 370, 0, 262, 0, 262, 0,
    392, 0, 311, 622, 311, 0, 262, 554,
    587, 554, 277, 262, 0, 554, 294, 277,
    466, 0, 294, 277, 784, 294, 0, 277,
    0, 262, 0, 262, 0, 262, 784, 262,
    0, 698, 740, 0, 311, 0, 262, 330,
    0, 262, 0, 440, 0, 415, 0, 262,
    0, 262, 0, 698, 0, 392, 415, 0,
    587, 0, 415, 0, 698, 0, 440, 0,
    262, 392, 262, 523, 262, 0, 311, 0,
    349, 0, 330, 0, 349, 0, 466, 0,
    466, 0, 466, 0, 466, 0, 392, 0,
    587, 0, 294, 0, 415, 392, 0, 523,
    0, 415, 0, 294, 0, 277, 0, 277,
    740, 277, 0, 294, 0, 523, 0, 740,
    0, 440, 0, 440, 0, 294, 0, 415,
    0, 349, 0, 831, 0, 784, 698, 0,
    415, 370, 0, 349, 554, 0, 370, 0,
    370, 0, 523, 262, 523, 554, 523, 262,
    0, 392, 0, 392, 0, 392, 0, 523,
    494, 523, 277, 0, 262, 523, 494, 262,
    0, 392, 0, 262, 0, 262, 0, 392,
    294, 0, 277, 0, 262, 698, 0, 262,
    0, 277, 294, 0, 294, 277, 0, 330,
    0, 587, 0, 262, 0, 277, 294, 0,
    294, 0, 262, 0, 262, 0, 262, 523,
    554, 523, 262, 0, 262, 554, 262, 523,
    0, 440, 0, 440, 466, 0, 466, 0,
    466, 0, 466, 0, 466, 0, 440, 0,
    440, 0, 311, 0, 330, 466, 0, 311,
    0, 466, 440, 0, 440, 262, 0, 466,
    0, 466, 0, 466, 0, 440, 0, 440,
    0, 311, 0, 392, 0, 392, 262, 0,
    392, 370, 0, 370, 0, 349, 0, 370,
    392, 0, 392, 0, 392, 0, 370, 262,
    0, 392, 311, 0, 523, 0, 523, 262,
    0, 262, 0, 311, 0, 311, 0, 523,
    0, 262, 523, 0, 370, 0, 370, 0,
    466, 0, 311, 0, 415, 0, 415, 466,
    440, 0, 330, 349, 0, 330, 349, 330,
    0, 262, 523, 262, 0, 523, 262, 0,
    415, 392, 415, 523, 311, 622, 311, 622,
    311, 0, 262, 0, 415, 392, 262, 415,
    262, 392, 370, 0, 277, 311, 622, 311,
    622, 0, 262, 392, 277, 294, 587, 554,
    277, 262, 0, 349, 0, 370, 392, 0,
    277, 587, 294, 0, 262, 523, 262, 0,
    277, 0, 262, 784, 262, 0, 740, 0,
    330, 0, 262, 0, 440, 0, 415, 0,
    262, 0, 440, 0, 262, 0, 311, 0,
    370, 0, 415, 0, 262, 740, 784, 0,
    494, 523, 494, 440, 0, 370, 349, 0,
    466, 0, 440, 0, 262, 0, 311, 0,
    262, 0, 466, 0, 466, 0, 466, 0,
    466, 0, 784, 0, 587, 0, 262, 0,
    415, 392, 0, 415, 0, 554, 262, 0,
    554, 0, 294, 0, 262, 294, 0, 330,
    0, 523, 0, 740, 523, 262, 0, 262,
    0, 262, 523, 0, 523, 262, 0, 523,
    0, 740, 0, 311, 0, 294, 0, 262,
    311, 0, 784, 0, 415, 0, 392, 277,
    0, 294, 0, 554, 0, 784, 0, 740,
    0, 740, 0, 784, 0, 349, 440, 0,
    415, 349, 0, 440, 740, 0, 262, 523,
    262, 554, 262, 523, 262, 0, 262, 0,
    392, 0, 277, 0, 523, 554, 523, 262,
    0, 392, 415, 0, 262, 0, 262, 0,
    262, 0, 277, 294, 0, 277, 0, 262,
    740, 0, 440, 0, 440, 0, 262, 0,
    277, 262, 294, 0, 294, 0, 294, 0,
    262, 0, 262, 0, 294, 0, 311, 294,
    0, 294, 0, 262, 0, 262, 0, 262,
    277, 523, 554, 523, 494, 466, 523, 262,
    523, 0, 262, 523, 0, 262, 0, 262,
    0, 587, 0, 622, 587, 0, 587, 0,
    294, 494, 0, 294, 0, 294, 311, 622,
    0, 622, 587, 622, 311, 415, 0, 415,
    262, 622, 311, 622, 311, 622, 311, 587,
    311, 0, 415, 622, 0, 311, 622, 311,
    622, 311, 0
};

// Duração das notas em milissegundos
const uint note_duration[] = {
    5968, 430, 139, 35, 23, 93, 35, 23,
    58, 23, 70, 46, 12, 46, 35, 23,
    128, 46, 70, 35, 116, 12, 35, 35,
    12, 23, 93, 23, 35, 70, 35, 12,
    93, 12, 58, 35, 35, 116, 46, 35,
    35, 139, 174, 46, 232, 128, 23, 58,
    104, 12, 70, 23, 23, 12, 104, 46,
    23, 104, 325, 116, 441, 23, 93, 35,
    46, 35, 35, 197, 46, 139, 12, 70,
    35, 209, 35, 70, 23, 70, 35, 46,
    12, 151, 12, 58, 116, 23, 12, 46,
    35, 23, 128, 151, 70, 174, 197, 23,
    627, 81, 116, 12, 70, 70, 46, 93,
    46, 46, 801, 35, 58, 23, 569, 151,
    81, 35, 964, 12, 23, 12, 372, 58,
    12, 35, 12, 23, 104, 128, 604, 46,
    511, 46, 1091, 46, 81, 325, 35, 1045,
    12, 453, 12, 12, 23, 2554, 360, 441,
    35, 12, 12, 58, 12, 23, 12, 23,
    46, 35, 35, 58, 104, 23, 418, 12,
    35, 232, 58, 12, 70, 627, 12, 12,
    929, 12, 12, 12, 244, 12, 70, 35,
    46, 313, 209, 93, 35, 766, 23, 35,
    81, 58, 23, 35, 395, 46, 23, 58,
    12, 35, 128, 46, 35, 23, 12, 81,
    650, 151, 58, 12, 488, 174, 35, 139,
    163, 12, 35, 975, 35, 255, 58, 35,
    23, 128, 882, 35, 267, 35, 12, 12,
    23, 46, 2183, 12, 139, 12, 12, 46,
    12, 81, 23, 372, 35, 2380, 35, 859,
    12, 46, 23, 12, 12, 139, 12, 441,
    46, 406, 35, 325, 12, 93, 46, 186,
    23, 12, 12, 627, 46, 313, 12, 406,
    12, 139, 58, 383, 35, 12, 279, 12,
    813, 46, 2171, 12, 12, 23, 824, 23,
    23, 12, 255, 35, 882, 35, 279, 35,
    406, 23, 12, 12, 81, 23, 360, 12,
    499, 12, 1057, 12, 35, 70, 23, 116,
    23, 46, 46, 12, 35, 279, 12, 12,
    12, 116, 35, 93, 58, 35, 46, 12,
    267, 81, 12, 116, 383, 12, 639, 46,
    23, 23, 23, 93, 35, 139, 12, 35,
    1614, 58, 940, 267, 139, 23, 395, 12,
    58, 12, 12, 139, 255, 35, 1834, 58,
    197, 93, 232, 58, 35, 46, 569, 35,
    1057, 35, 313, 116, 766, 23, 58, 23,
    93, 731, 104, 23, 12, 499, 70, 232,
    46, 81, 46, 46, 12, 35, 35, 58,
    348, 35, 116, 12, 46, 46, 58, 1091,
    58, 35, 209, 395, 23, 325, 58, 93,
    58, 139, 12, 104, 35, 23, 104, 23,
    290, 12, 35, 116, 23, 12, 104, 163,
    81, 93, 35, 23, 163, 35, 12, 35,
    221, 12, 1277, 23, 58, 46, 12, 290,
    23, 23, 81, 46, 186, 12, 93, 35,
    23, 70, 23, 325, 12, 104, 35, 23,
    151, 81, 12, 1289, 81, 58, 104, 12,
    35, 35, 290, 46, 871, 23, 244, 104,
    81, 12, 58, 499, 23, 383, 58, 580,
    104, 1149, 35, 1103, 46, 639, 12, 58,
    12, 383, 12, 58, 1800, 12, 23, 12,
    1370, 128, 46, 81, 12, 35, 12, 488,
    46, 23, 23, 35, 70, 58, 58, 58,
    46, 1370, 23, 975, 35, 23, 104, 23,
    163, 81, 12, 302, 12, 70, 139, 104,
    58, 685, 12, 12, 12, 81, 70, 12,
    35, 46, 139, 81, 35, 12, 35, 104,
    23, 23, 395, 720, 46, 46, 46, 104,
    81, 325, 163, 46, 151, 116, 46, 848,
    35, 418, 244, 1080, 46, 35, 46, 46,
    23, 697, 46, 128, 58, 929, 12, 35,
    35, 604, 35, 244, 23, 70, 12, 255,
    12, 23, 12, 35, 255, 46, 70, 1625,
    12, 23, 35, 824, 46, 35, 46, 104,
    12, 325, 35, 975, 46, 255, 23, 557,
    46, 522, 35, 174, 23, 337, 12, 186,
    23, 23, 1161, 81, 511, 35, 12, 1080,
    46, 58, 12, 128, 12, 46, 848, 35,
    639, 23, 70, 58, 12, 12, 279, 46,
    70, 23, 23, 35, 46, 12, 186, 35,
    58, 35, 81, 46, 221, 35, 58, 23,
    23, 128, 12, 186, 23, 151, 12, 23,
    1312, 35, 58, 12, 23, 12, 35, 12,
    23, 12, 23, 23, 116, 23, 46, 12,
    23, 12, 186, 58, 35, 232, 23, 23,
    12, 23, 58, 46, 58, 12, 12, 244,
    81, 1207, 70, 116, 12, 35, 93, 46,
    1858, 12, 46, 81, 58, 151, 46, 279,
    232, 615, 12, 116, 12, 12, 128, 232,
    35, 1103, 46, 139, 23, 511, 116, 163,
    35, 35, 372, 70, 58, 12, 12, 1788,
    46, 35, 81, 453, 35, 197, 23, 23,
    23, 186, 662, 104, 58, 46, 430, 12,
    12, 23, 23, 139, 12, 35, 70, 81,
    81, 58, 12, 46, 81, 35, 139, 58,
    93, 23, 23, 12, 58, 197, 46, 93,
    70, 35, 58, 12, 209, 12, 12, 12,
    35, 197, 12, 174, 12, 12, 23, 23,
    46, 46, 58, 209, 12, 279, 58, 81,
    12, 221, 12, 23, 12, 58, 46, 35,
    46, 93, 1184,
};

// Inicializa o PWM no pino do buzzer
void pwm_init_buzzer(uint pin) {
    gpio_set_function(pin, GPIO_FUNC_PWM);
    uint slice_num = pwm_gpio_to_slice_num(pin);
    pwm_config config = pwm_get_default_config();
    pwm_config_set_clkdiv(&config, 4.0f); // Ajusta divisor de clock
    pwm_init(slice_num, &config, true);
    pwm_set_gpio_level(pin, 0); // Desliga o PWM inicialmente
}

// Toca uma nota com a frequência e duração especificadas
void play_tone(uint pin, uint frequency, uint duration_ms) {
    uint slice_num = pwm_gpio_to_slice_num(pin);
    uint32_t clock_freq = clock_get_hz(clk_sys);
    uint32_t top = clock_freq / frequency - 1;

    pwm_set_wrap(slice_num, top);
    pwm_set_gpio_level(pin, top / 2); // 50% de duty cycle

    sleep_ms(duration_ms);

    pwm_set_gpio_level(pin, 0); // Desliga o som após a duração
    sleep_ms(50); // Pausa entre notas
}

// Função principal para tocar a música
void play_star_wars(uint pin) {
    for (int i = 0; i < sizeof(star_wars_notes) / sizeof(star_wars_notes[0]); i++) {
        if (star_wars_notes[i] == 0) {
            sleep_ms(note_duration[i]);
        } else {
            play_tone(pin, star_wars_notes[i], note_duration[i]);
        }
    }
}

int main() {
    stdio_init_all();
    pwm_init_buzzer(BUZZER_PIN);
    while(1){
      play_star_wars(BUZZER_PIN);
     
    }
   
    return 0;
}
